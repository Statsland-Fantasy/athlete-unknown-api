name: PR Checks

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch full history for better diff analysis

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.4'
          cache: true

      - name: Verify dependencies
        run: go mod verify

      - name: Download dependencies
        run: go mod download

      - name: Check code formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "⚠️ The following files are not formatted correctly:"
            gofmt -l .
            echo ""
            echo "Run 'gofmt -w .' to fix formatting issues"
            exit 1
          fi
          echo "✅ All files are properly formatted"

      - name: Run go vet
        run: go vet ./...

      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Calculate coverage
        id: coverage
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "Total coverage: $COVERAGE"
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Build application
        run: go build -v -o athlete-unknown-api

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --timeout=5m
        continue-on-error: true

      - name: Check for sensitive data
        run: |
          echo "Checking for potential secrets in code..."
          # Check for common sensitive patterns
          if grep -r "password.*=.*\"" . --include="*.go" | grep -v "test" | grep -v "//" ; then
            echo "⚠️ Potential hardcoded password found"
          fi
          if grep -r "api[_-]key.*=.*\"" . --include="*.go" | grep -v "test" | grep -v "//" ; then
            echo "⚠️ Potential hardcoded API key found"
          fi
          echo "✅ Sensitive data check complete"
        continue-on-error: true

      - name: Comment PR with build status
        uses: actions/github-script@v8
        if: always()
        with:
          script: |
            const status = '${{ job.status }}';
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const emoji = status === 'success' ? '✅' : '❌';
            const body = `${emoji} **PR Checks ${status}**

            **Commit:** ${context.sha.substring(0, 7)}
            **Build:** ${status}
            **Test Coverage:** ${coverage}

            View full details in the [Actions tab](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
